// Test Peer Match Introduction Message
// Tests BullMQ + eventMessageWorker integration for peer matching

const { scheduleEventMessage } = require('./tpe-backend/src/queues/eventMessageQueue');
const { query } = require('./tpe-backend/src/config/database');

async function testPeerMatchIntroduction() {
  console.log('🧪 Testing Peer Match Introduction Message...\\n');

  try {
    // Get test contractor
    const contractorResult = await query(`
      SELECT id, phone, name, first_name, last_name, email, company_name
      FROM contractors
      WHERE phone = $1
    `, ['+18108934075']);

    if (contractorResult.rows.length === 0) {
      console.error('❌ Test contractor not found (phone: +18108934075)');
      process.exit(1);
    }

    const contractor = contractorResult.rows[0];
    console.log('✅ Found test contractor:', contractor.name);

    // Create test peer match introduction message in database
    const messageResult = await query(`
      INSERT INTO event_messages (
        event_id,
        contractor_id,
        message_type,
        message_category,
        scheduled_time,
        message_content,
        personalization_data,
        phone,
        status,
        direction,
        created_at,
        updated_at
      ) VALUES ($1, $2, $3, $4, NOW() + INTERVAL '10 seconds', $5, $6, $7, 'scheduled', 'outbound', NOW(), NOW())
      RETURNING id, scheduled_time
    `, [
      41, // Event ID (Business Growth Expo)
      contractor.id,
      'peer_match_introduction',
      'peer_matching',
      '', // Empty message_content - will be generated by worker
      JSON.stringify({
        match_id: 999, // Test match ID
        peer_contractor_id: 999, // Test peer ID
        peer_name: 'Sarah Martinez',
        peer_company: 'Martinez Construction Inc',
        peer_location: 'Miami, FL',
        match_reason: 'both focused on scaling operations and team management',
        match_score: 0.87
      }),
      contractor.phone
    ]);

    const message = messageResult.rows[0];
    console.log('✅ Created peer match introduction message in database (ID:', message.id + ')');
    console.log('📅 Scheduled for:', message.scheduled_time);

    // Schedule message in BullMQ
    const job = await scheduleEventMessage({
      id: message.id, // Queue expects 'id' not 'message_id'
      event_id: 41,
      contractor_id: contractor.id,
      message_type: 'peer_match_introduction',
      message_category: 'peer_matching',
      scheduled_time: message.scheduled_time,
      phone: contractor.phone
    });

    console.log('✅ Message scheduled in BullMQ (Job ID:', job.id + ')');
    console.log('\\n📱 Peer match introduction will be sent to', contractor.phone, 'in ~10 seconds');
    console.log('\\n⏳ Make sure the event message worker is running:');
    console.log('   node tpe-backend/src/workers/eventMessageWorker.js');
    console.log('\\n👀 Watch for:');
    console.log('   1. Worker log: "Processing message..."');
    console.log('   2. SMS received: "Hey [name]! 👋 Find Your Peer: I found someone perfect for you to meet!"');
    console.log('   3. Database updated: status = "sent"');

    // Check message status after 15 seconds
    setTimeout(async () => {
      const statusResult = await query(`
        SELECT id, status, actual_send_time, error_message, message_content
        FROM event_messages
        WHERE id = $1
      `, [message.id]);

      const updatedMessage = statusResult.rows[0];
      console.log('\\n📊 Message Status After 15s:');
      console.log('   Status:', updatedMessage.status);
      console.log('   Sent At:', updatedMessage.actual_send_time || 'Not sent yet');
      console.log('   Message Preview:', updatedMessage.message_content?.substring(0, 100) + '...');

      if (updatedMessage.error_message) {
        console.log('   Error:', updatedMessage.error_message);
      }

      if (updatedMessage.status === 'sent') {
        console.log('\\n✅ TEST PASSED! Peer match introduction sent successfully!');
        console.log('\\n📝 Next Steps:');
        console.log('   1. Reply "YES" to test peer match interest handler');
        console.log('   2. Reply "LATER" to test deferred response');
        console.log('   3. Reply "Tell me more" to test info request');
      } else if (updatedMessage.status === 'failed') {
        console.log('\\n❌ TEST FAILED! Message failed to send.');
      } else {
        console.log('\\n⏳ Still processing... Check worker logs.');
      }

      process.exit(0);
    }, 15000);

  } catch (error) {
    console.error('\\n❌ Test failed:', error.message);
    console.error(error.stack);
    process.exit(1);
  }
}

testPeerMatchIntroduction();
